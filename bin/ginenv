#!/usr/bin/env bash

GIN_TARGET_MIGRATION_LEVEL=1

GIN_PATH=$(readlink -f "$(dirname "$(readlink -f "$0")")/..")
GIN_BIN="$GIN_PATH/bin"
GIN_STAGING="$GIN_PATH/staging"
GIN_CONFIG="$GIN_PATH/config"
GIN_RUNNERS="$GIN_PATH/runners"
GIN_PREFIXES="$GIN_PATH/prefixes"

function getcfg() {
    if [ ! -f "$GIN_CONFIG/$1" ]; then
        echo ""
        return 1
    fi

    local VALUE=$(tr -d '[:space:]' < "$GIN_CONFIG/$1")
    echo "$VALUE"

    return 0
}

function setcfg() {
    echo -n "$2" > "$GIN_CONFIG/$1"
}

function get_migration_level() {
    if [ ! -f "$GIN_CONFIG/migration_level" ]; then
        echo "0"
        GIN_MIGRATION_LEVEL="0"
        return 0
    fi
    
    local level="$(getcfg migration_level)"
    echo "$level"
    GIN_MIGRATION_LEVEL="$level"

    return 0
}

function set_migration_level() {
    setcfg migration_level "$1"
    GIN_MIGRATION_LEVEL="$1"
}

if [ "$(get_migration_level)" -lt "$GIN_TARGET_MIGRATION_LEVEL" ]; then
    if [ "$GIN_MIGRATION_LEVEL" = "0" ]; then
        mkdir -p "$GIN_CONFIG"
        mkdir -p "$GIN_RUNNERS"
        mkdir -p "$GIN_PREFIXES"
        mkdir -p "$GIN_STAGING"
        
        set_migration_level 1
    fi
fi

export PATH="$GIN_BIN:$PATH"

function is_valid_runner_set() {
    if [[ $GIN_OVERRIDES == *"no_runner_check"* ]]; then
        return 0
    fi

    if [ -f "$GIN_CONFIG/runner" ]; then
        local runner=$(getcfg runner)
        if [ -d "$GIN_RUNNERS/$runner" ]; then
            return 0
        else
            return 1
        fi
    else
        return 1
    fi
}

function runner_exists() {
    if [[ $GIN_OVERRIDES == *"no_runner_check"* ]]; then
        return 0
    fi

    if [ -d "$GIN_RUNNERS/$1" ]; then
        return 0
    else
        return 1
    fi
}

function get_runner_path() {
    if [ -z "$1" ]; then
         local RUNNER_NAME=$(getcfg runner)
        echo "$GIN_RUNNERS/$RUNNER_NAME"
        return 0
    else
        local runner_path="$GIN_RUNNERS/$1"
        if [ -d "$runner_path" ]; then
            echo "$runner_path"
            return 0
        else
            return 1
        fi
    fi
    
}

function assert_valid_runner_set() {
    if ! is_valid_runner_set; then
        if [ ! -d "$GIN_RUNNERS" ] || [ -z "$(ls -A "$GIN_RUNNERS")" ]; then
            echo "No runners installed. Please install a runner using 'gincfg runner install <runner_name> <runner_url>'."
        else
            echo "No valid runner set. Please set a runner using 'gincfg runner set <runner_name>'."
            echo "Available runners:"
            ls "$GIN_RUNNERS"
        fi    

        exit 1
    fi
}

function is_valid_prefix_set() {
    if [[ $GIN_OVERRIDES == *"no_prefix_check"* ]]; then
        return 0
    fi

    if [ -f "$GIN_CONFIG/prefix" ]; then
        local prefix=$(getcfg prefix)
        if [ -d "$GIN_PREFIXES/$prefix" ]; then
            return 0
        else
            return 1
        fi
    else
        return 1
    fi
}

function prefix_exists() {
    if [[ $GIN_OVERRIDES == *"no_prefix_check"* ]]; then
        return 0
    fi
    
    if [ ! -z "$WINEPREFIX" ] && [ -d "$WINEPREFIX" ]; then
        return 0
    fi

    if [ -d "$GIN_PREFIXES/$1" ]; then
        return 0
    else
        return 1
    fi
}

function get_prefix_path() {
    if [ ! -z "$WINEPREFIX" ]; then
        echo "$WINEPREFIX"
        return 0
    fi

    if [ -z "$1" ]; then
        local PREFIX_NAME=$(getcfg prefix)
        echo "$GIN_PREFIXES/$PREFIX_NAME"
        return 0
    else
        local prefix_path="$GIN_PREFIXES/$1"

        if [ -d "$prefix_path" ]; then
            echo "$prefix_path"
            return 0
        else
            return 1
        fi
    fi
    
}

function assert_valid_prefix_set() {
    if ! is_valid_prefix_set; then
        if [ ! -d "$GIN_PREFIXES" ] || [ -z "$(ls -A "$GIN_PREFIXES")" ]; then
            echo "No prefixes installed. Please install a prefix using 'gincfg prefix create <prefix_name>'."
        else
            echo "No valid prefix set. Please set a prefix using 'gincfg prefix set <prefix_name>'."
            echo "Available prefixes:"
            ls "$GIN_PREFIXES"
        fi    

        exit 1
    fi
}